[{"data":1,"prerenderedAt":174},["Reactive",2],{"content-query-zkzoMwMPuf":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":9,"body":10,"_type":169,"_id":170,"_source":171,"_file":172,"_extension":173},"/docs/core-tech/beam-wallet-database","core-tech",false,"","Beam Wallet Database","Since in Mimblewimble only UTXO related information is available on chain, most of the Wallet state should be maintained locally and store in the Wallet Database, which is described in this chapter.",{"type":11,"children":12,"toc":164},"root",[13,20,25,50,66,71,77,91,104,111,130,139,145],{"type":14,"tag":15,"props":16,"children":17},"element","p",{},[18],{"type":19,"value":9},"text",{"type":14,"tag":15,"props":21,"children":22},{},[23],{"type":19,"value":24},"Beam Wallet stores and tracks information about four key entities:",{"type":14,"tag":26,"props":27,"children":28},"ol",{},[29,35,40,45],{"type":14,"tag":30,"props":31,"children":32},"li",{},[33],{"type":19,"value":34},"Coins",{"type":14,"tag":30,"props":36,"children":37},{},[38],{"type":19,"value":39},"Addresses",{"type":14,"tag":30,"props":41,"children":42},{},[43],{"type":19,"value":44},"Transactions",{"type":14,"tag":30,"props":46,"children":47},{},[48],{"type":19,"value":49},"Blockchain State",{"type":14,"tag":15,"props":51,"children":52},{},[53,55,64],{"type":19,"value":54},"The interface for the database is specified in the ",{"type":14,"tag":56,"props":57,"children":61},"a",{"href":58,"rel":59},"https://github.com/BeamMW/beam/blob/56e9cdd7be211649a576fa15d3f0a97922ae2acd/wallet/wallet_db.h#L164",[60],"nofollow",[62],{"type":19,"value":63},"wallet_db.h",{"type":19,"value":65}," file",{"type":14,"tag":15,"props":67,"children":68},{},[69],{"type":19,"value":70},"Beam currently uses sqlite relational database in the implementation",{"type":14,"tag":72,"props":73,"children":75},"h1",{"id":74},"coins",[76],{"type":19,"value":34},{"type":14,"tag":15,"props":78,"children":79},{},[80,82,89],{"type":19,"value":81},"We will start with the ",{"type":14,"tag":56,"props":83,"children":86},{"href":84,"rel":85},"https://github.com/BeamMW/beam/blob/56e9cdd7be211649a576fa15d3f0a97922ae2acd/wallet/wallet_db.h#L41",[60],[87],{"type":19,"value":88},"definition",{"type":19,"value":90}," of a Coin structure, which represents a UTXO as it is seen by the wallet.",{"type":14,"tag":92,"props":93,"children":98},"pre",{"className":94,"code":96,"language":97,"meta":7},[95],"language-c++","\n    // Describes a UTXO in the context of the Wallet\n    struct Coin\n    {\n        // Status is not stored in the database but can be\n        // deduced from the current blockchain state\n        enum Status\n        {\n            Unavailable, // initial status of a new UTXO\n            Available,   // UTXO is currently present in the chain and can be spent\n            Maturing,    // UTXO is present in the chain has maturity higher than current height (i.e coinbase or treasury)\n            Outgoing,    // Available and participates in outgoing transaction\n            Incoming,    // Outputs of incoming transaction, currently unavailable\n            ChangeV0,    // deprecated.\n            Spent,       // UTXO that was spent. Stored in wallet database until reset or restore\n\n            count\n        };\n\n        Coin(Amount amount = 0, Key::Type keyType = Key::Type::Regular);\n        bool operator==(const Coin&) const;\n        bool operator!=(const Coin&) const;\n        bool isReward() const;\n        std::string toStringID() const;\n        Amount getAmount() const;\n\n        typedef Key::IDV ID; // unique identifier for the coin (including value), can be used to create blinding factor \n        ID m_ID;\n\n        Status m_status;        // current status of the coin\n        Height m_maturity;      // coin can be spent only when chain is >= this value. Valid for confirmed coins (Available, Outgoing, Incoming, Change, Spent, Maturing).\n\n                                // The following fields are used to derive the status of the transaction\n        Height m_confirmHeight; // height at which the coin was confirmed (appeared in the chain)\n        Height m_spentHeight;   // height at which the coin was spent\n\n        boost::optional\u003CTxID> m_createTxId;  // id of the transaction which created the UTXO\n        boost::optional\u003CTxID> m_spentTxId;   // id of the transaction which spernt the UTXO\n        \n        uint64_t m_sessionId;   // Used in the API to lock coins for specific session (see https://github.com/BeamMW/beam/wiki/Beam-wallet-protocol-API#tx_split)\n\n        bool IsMaturityValid() const; // is/was the UTXO confirmed?\n        Height get_Maturity() const; // would return MaxHeight unless the UTXO was confirmed\n        \n        std::string getStatusString() const;\n        static boost::optional\u003CCoin::ID> FromString(const std::string& str);\n    };\n","c++",[99],{"type":14,"tag":100,"props":101,"children":102},"code",{"__ignoreMap":7},[103],{"type":19,"value":96},{"type":14,"tag":105,"props":106,"children":108},"h2",{"id":107},"deducing-coin-status",[109],{"type":19,"value":110},"Deducing Coin Status",{"type":14,"tag":15,"props":112,"children":113},{},[114,116,121,123,128],{"type":19,"value":115},"By monitoring the state of the blockchain, the wallet can always deduce the current status of each coin by tracking the m_confirmHeight height and m_spentHeight. This is done in the ",{"type":14,"tag":100,"props":117,"children":118},{"className":7},[119],{"type":19,"value":120},"void DeduceStatus(const IWalletDB&, Coin&, Height hTop);",{"type":19,"value":122}," method which calls the ",{"type":14,"tag":100,"props":124,"children":125},{"className":7},[126],{"type":19,"value":127},"Coin::Status GetCoinStatus(const IWalletDB&, const Coin&, Height hTop);",{"type":19,"value":129}," method that in turn returns the current status of the coin.",{"type":14,"tag":92,"props":131,"children":134},{"className":132,"code":133,"language":97,"meta":7},[95],"\nCoin::Status GetCoinStatus(const IWalletDB& walletDB, const Coin& c, Height hTop)\n{\n    if (c.m_spentHeight != MaxHeight)\n        return Coin::Status::Spent;\n\n    if (c.m_confirmHeight != MaxHeight)\n    {\n        if (c.m_maturity > hTop)\n            return Coin::Status::Maturing;\n\n        if (IsOngoingTx(walletDB, c.m_spentTxId))\n            return Coin::Status::Outgoing;\n\n        return Coin::Status::Available;\n    }\n\n    if (IsOngoingTx(walletDB, c.m_createTxId))\n        return Coin::Status::Incoming;\n\n    return Coin::Status::Unavailable;\n}\n",[135],{"type":14,"tag":100,"props":136,"children":137},{"__ignoreMap":7},[138],{"type":19,"value":133},{"type":14,"tag":105,"props":140,"children":142},{"id":141},"selecting-coins-for-a-specified-amount",[143],{"type":19,"value":144},"Selecting coins for a specified amount",{"type":14,"tag":15,"props":146,"children":147},{},[148,150,155,157,162],{"type":19,"value":149},"Implemented in the ",{"type":14,"tag":100,"props":151,"children":152},{"className":7},[153],{"type":19,"value":154},"std::vector\u003CCoin> selectCoins(Amount amount) override;",{"type":19,"value":156}," method. The purpose of the function is to select Coins matching a specific amount (for example in sending scenario). Selection method should minimize number of Coins and the change outputs and hence use greedy strategy with some additional heuristics. Specific strategies for coin selection are implemented in the ",{"type":14,"tag":100,"props":158,"children":159},{"className":7},[160],{"type":19,"value":161},"struct CoinSelector3",{"type":19,"value":163}," in honor of three attempts to write an effective selector for large amount of coins.",{"title":7,"searchDepth":165,"depth":165,"links":166},2,[167,168],{"id":107,"depth":165,"text":110},{"id":141,"depth":165,"text":144},"markdown","content:docs:core-tech:Beam-Wallet-Database.md","content","docs/core-tech/Beam-Wallet-Database.md","md",1702260893591]