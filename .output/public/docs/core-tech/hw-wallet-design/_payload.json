[{"data":1,"prerenderedAt":1056},["Reactive",2],{"content-query-OAu5t7Mbk4":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":7,"body":9,"_type":1051,"_id":1052,"_source":1053,"_file":1054,"_extension":1055},"/docs/core-tech/hw-wallet-design","core-tech",false,"","HW Wallet Design",{"type":10,"children":11,"toc":1036},"root",[12,21,27,32,52,59,119,138,161,179,184,190,369,403,427,451,458,463,468,512,517,530,535,541,546,585,590,596,607,633,650,656,661,685,697,702,720,725,731,742,758,764,775,790,795,808,824,835,869,875,886,898,903,914,934,940,951,962,967,979,995,1018],{"type":13,"tag":14,"props":15,"children":17},"element","h3",{"id":16},"beam-vs-other-blockchains",[18],{"type":19,"value":20},"text","Beam vs other blockchains",{"type":13,"tag":22,"props":23,"children":24},"p",{},[25],{"type":19,"value":26},"Beam HW wallet supports the functionality similar to other blockchain protocols, such as keeping all the secret keys within the device, and signing transactions authorized by the users.",{"type":13,"tag":22,"props":28,"children":29},{},[30],{"type":19,"value":31},"Since Beam is based in MW, the design of such a wallet is more complex, because of the following:",{"type":13,"tag":33,"props":34,"children":35},"ul",{},[36,42,47],{"type":13,"tag":37,"props":38,"children":39},"li",{},[40],{"type":19,"value":41},"Transactions are built interactively",{"type":13,"tag":37,"props":43,"children":44},{},[45],{"type":19,"value":46},"No addresses",{"type":13,"tag":37,"props":48,"children":49},{},[50],{"type":19,"value":51},"No transactions in the common sense. Transaction elements can be added and removed",{"type":13,"tag":53,"props":54,"children":56},"h2",{"id":55},"assumptions",[57],{"type":19,"value":58},"Assumptions",{"type":13,"tag":60,"props":61,"children":62},"ol",{},[63,68,73,78],{"type":13,"tag":37,"props":64,"children":65},{},[66],{"type":19,"value":67},"The HW wallet is a minimalistic stateless device. It should not handle blockchain events (blocks, headers, reorgs), handle BBS traffic, fully negotiate transactions, and etc.",{"type":13,"tag":37,"props":69,"children":70},{},[71],{"type":19,"value":72},"The host may be compromised, yet no spend should be possible without user's permission.",{"type":13,"tag":37,"props":74,"children":75},{},[76],{"type":19,"value":77},"Once the user activates the HW wallet (enters the pin-code), the host can view all the user information (balance, UTXOs), but not spend funds.",{"type":13,"tag":37,"props":79,"children":80},{},[81,83,111],{"type":19,"value":82},"Every spend (transaction that assumes user spends funds) needs a user authorization. The user sees the following:\n",{"type":13,"tag":60,"props":84,"children":85},{},[86,91,96,101,106],{"type":13,"tag":37,"props":87,"children":88},{},[89],{"type":19,"value":90},"The amount being-sent",{"type":13,"tag":37,"props":92,"children":93},{},[94],{"type":19,"value":95},"Asset type (beam or CA).",{"type":13,"tag":37,"props":97,"children":98},{},[99],{"type":19,"value":100},"Recipient identifier.",{"type":13,"tag":37,"props":102,"children":103},{},[104],{"type":19,"value":105},"Transaction kernel ID.",{"type":13,"tag":37,"props":107,"children":108},{},[109],{"type":19,"value":110},"Height range (min/max height) during which the transaction is valid.",{"type":13,"tag":33,"props":112,"children":113},{},[114],{"type":13,"tag":37,"props":115,"children":116},{},[117],{"type":19,"value":118},"All this information is cryptographically verified, and there should be no feasible way for the host to tamper with it.",{"type":13,"tag":22,"props":120,"children":121},{},[122,128,130,136],{"type":13,"tag":123,"props":124,"children":125},"strong",{},[126],{"type":19,"value":127},"Note:",{"type":19,"value":129}," Because in MW transactions are essentially (sort of) Schnorr's multisignatures, the (1) is actually tricky to implement. To create a Schnorr's signature the signer generates a ",{"type":13,"tag":131,"props":132,"children":133},"em",{},[134],{"type":19,"value":135},"nonce",{"type":19,"value":137},", which must be retained for the duration of the multi-signature ritual.",{"type":13,"tag":22,"props":139,"children":140},{},[141,143,147,149,153,155,159],{"type":19,"value":142},"We solve this by assuming the device has a limited non-volatile memory that can be used to store ",{"type":13,"tag":131,"props":144,"children":145},{},[146],{"type":19,"value":135},{"type":19,"value":148}," preimage (source material). We make sure that neither the ",{"type":13,"tag":131,"props":150,"children":151},{},[152],{"type":19,"value":135},{"type":19,"value":154}," nor the appropriate secret key can be extracted by malicious host (such as attempt to use the same ",{"type":13,"tag":131,"props":156,"children":157},{},[158],{"type":19,"value":135},{"type":19,"value":160}," to sign different things).",{"type":13,"tag":22,"props":162,"children":163},{},[164,166,171,173,177],{"type":19,"value":165},"The HW wallet device should have several 256-bit ",{"type":13,"tag":131,"props":167,"children":168},{},[169],{"type":19,"value":170},"slots",{"type":19,"value":172}," for ",{"type":13,"tag":131,"props":174,"children":175},{},[176],{"type":19,"value":135},{"type":19,"value":178}," preimages. The more slots it has - the more ongoing transactions the HW wallet may handle at the same time.",{"type":13,"tag":22,"props":180,"children":181},{},[182],{"type":19,"value":183},"(There is also an option of using VRFs, but it's too complex for HW wallets.)",{"type":13,"tag":53,"props":185,"children":187},{"id":186},"terminology",[188],{"type":19,"value":189},"Terminology",{"type":13,"tag":33,"props":191,"children":192},{},[193,275,285,307,317,332],{"type":13,"tag":37,"props":194,"children":195},{},[196,202,204,254],{"type":13,"tag":197,"props":198,"children":199},"code",{"className":7},[200],{"type":19,"value":201},"CoinID",{"type":19,"value":203}," - full UTXO identifier. Consists of the following:\n",{"type":13,"tag":60,"props":205,"children":206},{},[207,224,234,244],{"type":13,"tag":37,"props":208,"children":209},{},[210,215,217,222],{"type":13,"tag":197,"props":211,"children":212},{"className":7},[213],{"type":19,"value":214},"SubIdx",{"type":19,"value":216}," 32-bit ",{"type":13,"tag":131,"props":218,"children":219},{},[220],{"type":19,"value":221},"child",{"type":19,"value":223}," key identifier",{"type":13,"tag":37,"props":225,"children":226},{},[227,232],{"type":13,"tag":197,"props":228,"children":229},{"className":7},[230],{"type":19,"value":231},"Idx",{"type":19,"value":233}," 64-bit coin number",{"type":13,"tag":37,"props":235,"children":236},{},[237,242],{"type":13,"tag":197,"props":238,"children":239},{"className":7},[240],{"type":19,"value":241},"Value",{"type":19,"value":243}," (64 bits)",{"type":13,"tag":37,"props":245,"children":246},{},[247,252],{"type":13,"tag":197,"props":248,"children":249},{"className":7},[250],{"type":19,"value":251},"AssetID",{"type":19,"value":253}," (32-bit number)",{"type":13,"tag":33,"props":255,"children":256},{},[257],{"type":13,"tag":37,"props":258,"children":259},{},[260,262,266,268,273],{"type":19,"value":261},"For each ",{"type":13,"tag":197,"props":263,"children":264},{"className":7},[265],{"type":19,"value":201},{"type":19,"value":267}," the HW wallet generates a unique ",{"type":13,"tag":131,"props":269,"children":270},{},[271],{"type":19,"value":272},"blinding factor",{"type":19,"value":274}," using the master secret.",{"type":13,"tag":37,"props":276,"children":277},{},[278,283],{"type":13,"tag":197,"props":279,"children":280},{"className":7},[281],{"type":19,"value":282},"OwnerKey",{"type":19,"value":284}," - derived from the master secret, used to recognize the owned UTXOs.",{"type":13,"tag":37,"props":286,"children":287},{},[288,293,295,299,301,305],{"type":13,"tag":197,"props":289,"children":290},{"className":7},[291],{"type":19,"value":292},"P-Kdf",{"type":19,"value":294}," - public key generator, which for a ",{"type":13,"tag":197,"props":296,"children":297},{"className":7},[298],{"type":19,"value":201},{"type":19,"value":300}," generates an appropriate public key (EC point) that corresponds to its ",{"type":13,"tag":131,"props":302,"children":303},{},[304],{"type":19,"value":272},{"type":19,"value":306},".",{"type":13,"tag":37,"props":308,"children":309},{},[310,315],{"type":13,"tag":197,"props":311,"children":312},{"className":7},[313],{"type":19,"value":314},"IdentityNumber",{"type":19,"value":316}," 32-bit number",{"type":13,"tag":37,"props":318,"children":319},{},[320,325,327,331],{"type":13,"tag":197,"props":321,"children":322},{"className":7},[323],{"type":19,"value":324},"Identity",{"type":19,"value":326}," - public key that corresponds to the unique private key generated for specific ",{"type":13,"tag":197,"props":328,"children":329},{"className":7},[330],{"type":19,"value":314},{"type":19,"value":306},{"type":13,"tag":37,"props":333,"children":334},{},[335,340,342],{"type":13,"tag":197,"props":336,"children":337},{"className":7},[338],{"type":19,"value":339},"PaymentProof",{"type":19,"value":341}," - Schnorr's signature, signed by the receiver, that it receives funds as a result of the transaction. The signature signs the following parameters:\n",{"type":13,"tag":33,"props":343,"children":344},{},[345,350,355,360],{"type":13,"tag":37,"props":346,"children":347},{},[348],{"type":19,"value":349},"Value received",{"type":13,"tag":37,"props":351,"children":352},{},[353],{"type":19,"value":354},"Asset type",{"type":13,"tag":37,"props":356,"children":357},{},[358],{"type":19,"value":359},"Kernel ID",{"type":13,"tag":37,"props":361,"children":362},{},[363,365],{"type":19,"value":364},"Sender ",{"type":13,"tag":197,"props":366,"children":367},{"className":7},[368],{"type":19,"value":324},{"type":13,"tag":22,"props":370,"children":371},{},[372,376,378,382,384,389,391,395,397,401],{"type":13,"tag":123,"props":373,"children":374},{},[375],{"type":19,"value":127},{"type":19,"value":377}," the actual key generation is according to HKDF (rfc-5869). The generated ",{"type":13,"tag":131,"props":379,"children":380},{},[381],{"type":19,"value":272},{"type":19,"value":383}," depends in a non-transparent way on ",{"type":13,"tag":123,"props":385,"children":386},{},[387],{"type":19,"value":388},"all",{"type":19,"value":390}," the fields of ",{"type":13,"tag":197,"props":392,"children":393},{"className":7},[394],{"type":19,"value":201},{"type":19,"value":396},", thus there's no feasible way to tamper with them and adjust the resulting ",{"type":13,"tag":131,"props":398,"children":399},{},[400],{"type":19,"value":272},{"type":19,"value":402}," accordingly.",{"type":13,"tag":22,"props":404,"children":405},{},[406,408,413,415,419,421,425],{"type":19,"value":407},"In addition to HKDF, each computed key is multiplied by a fixed secret scalar, so-called ",{"type":13,"tag":131,"props":409,"children":410},{},[411],{"type":19,"value":412},"co-factor",{"type":19,"value":414},". The ",{"type":13,"tag":197,"props":416,"children":417},{"className":7},[418],{"type":19,"value":292},{"type":19,"value":420}," contains the same seed HKDF data, but the ",{"type":13,"tag":131,"props":422,"children":423},{},[424],{"type":19,"value":412},{"type":19,"value":426}," is replaced by its image (EC point).",{"type":13,"tag":22,"props":428,"children":429},{},[430,435,437,442,444,449],{"type":13,"tag":123,"props":431,"children":432},{},[433],{"type":19,"value":434},"Note (2):",{"type":19,"value":436}," To denote the UTXO Beam actually uses so-called ",{"type":13,"tag":131,"props":438,"children":439},{},[440],{"type":19,"value":441},"switch",{"type":19,"value":443}," commitments, which are compressed el-Gamal commitments. So that in practice the obtained ",{"type":13,"tag":131,"props":445,"children":446},{},[447],{"type":19,"value":448},"blidning factor",{"type":19,"value":450}," gets an addition, which depends on the committed value and asset type. The host can calculate this addition alone (without the HW wallet).",{"type":13,"tag":452,"props":453,"children":455},"h1",{"id":454},"functionality-high-level",[456],{"type":19,"value":457},"Functionality high-level",{"type":13,"tag":22,"props":459,"children":460},{},[461],{"type":19,"value":462},"All the HW wallet functionality comes down to the following methods.",{"type":13,"tag":22,"props":464,"children":465},{},[466],{"type":19,"value":467},"The following is returned without user permission",{"type":13,"tag":33,"props":469,"children":470},{},[471,476,483,498,507],{"type":13,"tag":37,"props":472,"children":473},{},[474],{"type":19,"value":475},"Number of slots available",{"type":13,"tag":37,"props":477,"children":478},{},[479],{"type":13,"tag":197,"props":480,"children":481},{"className":7},[482],{"type":19,"value":282},{"type":13,"tag":37,"props":484,"children":485},{},[486,490,492,496],{"type":13,"tag":197,"props":487,"children":488},{"className":7},[489],{"type":19,"value":292},{"type":19,"value":491}," for arbitrary ",{"type":13,"tag":131,"props":493,"children":494},{},[495],{"type":19,"value":221},{"type":19,"value":497}," key",{"type":13,"tag":37,"props":499,"children":500},{},[501,503],{"type":19,"value":502},"Rangeproof for arbitrary ",{"type":13,"tag":197,"props":504,"children":505},{"className":7},[506],{"type":19,"value":201},{"type":13,"tag":37,"props":508,"children":509},{},[510],{"type":19,"value":511},"signature for receive transaction kernel (i.e. transaction in which no funds are lost).",{"type":13,"tag":22,"props":513,"children":514},{},[515],{"type":19,"value":516},"The following needs user permission",{"type":13,"tag":33,"props":518,"children":519},{},[520,525],{"type":13,"tag":37,"props":521,"children":522},{},[523],{"type":19,"value":524},"signature for send transaction kernel",{"type":13,"tag":37,"props":526,"children":527},{},[528],{"type":19,"value":529},"signature for split transaction kernel (i.e. only transaction fee is lost)",{"type":13,"tag":22,"props":531,"children":532},{},[533],{"type":19,"value":534},"During the HW wallet initialization it generates a seed using the true random generator (available on most HW wallets), which is used to set initial values in all the slots.",{"type":13,"tag":452,"props":536,"children":538},{"id":537},"why-this-design-is-secure",[539],{"type":19,"value":540},"Why this design is secure?",{"type":13,"tag":22,"props":542,"children":543},{},[544],{"type":19,"value":545},"MW transaction consists of 3 things: inputs, outputs, and transaction kernels.",{"type":13,"tag":33,"props":547,"children":548},{},[549,580],{"type":13,"tag":37,"props":550,"children":551},{},[552,554,558,560,564,566,572,574,578],{"type":19,"value":553},"Input is denoted by its Pedersen (switch) commitment. The host can create it for any ",{"type":13,"tag":197,"props":555,"children":556},{"className":7},[557],{"type":19,"value":201},{"type":19,"value":559},", since only ",{"type":13,"tag":131,"props":561,"children":562},{},[563],{"type":19,"value":272},{"type":19,"value":565}," ",{"type":13,"tag":567,"props":568,"children":569},"u",{},[570],{"type":19,"value":571},"image",{"type":19,"value":573}," is needed, and ",{"type":13,"tag":197,"props":575,"children":576},{"className":7},[577],{"type":19,"value":292},{"type":19,"value":579}," is exported freely.",{"type":13,"tag":37,"props":581,"children":582},{},[583],{"type":19,"value":584},"Output consists of Pedersen (switch) commitment and the rangeproof. The commitment is calculated by the host (as for inputs), and the rangeproof is calculated by the HW wallet without any restriction.",{"type":13,"tag":22,"props":586,"children":587},{},[588],{"type":19,"value":589},"So, both inputs and outputs can be created by the host without any restrictions. But to build a valid (balanced) MW transaction the corresponding transaction kernel is required, and this is where HW wallet restrictions come into play. As we mentioned, HW wallet requests user permission along with the verifiable recipient ID for any spend transaction.",{"type":13,"tag":53,"props":591,"children":593},{"id":592},"how-do-we-verify-the-transaction-is-indeed-spendingreceiving-or-splitting",[594],{"type":19,"value":595},"How do we verify the transaction is indeed spending/receiving, or splitting?",{"type":13,"tag":22,"props":597,"children":598},{},[599,601,605],{"type":19,"value":600},"For all transactions the host specifies the input/output ",{"type":13,"tag":197,"props":602,"children":603},{"className":7},[604],{"type":19,"value":201},{"type":19,"value":606},"s that belong to the user before/after the transaction. Based on them the HW wallet deduces:",{"type":13,"tag":60,"props":608,"children":609},{},[610,615],{"type":13,"tag":37,"props":611,"children":612},{},[613],{"type":19,"value":614},"Overall value and asset which is obtained/lost in a transaction",{"type":13,"tag":37,"props":616,"children":617},{},[618,620,624,626,631],{"type":19,"value":619},"excess ",{"type":13,"tag":131,"props":621,"children":622},{},[623],{"type":19,"value":272},{"type":19,"value":625}," (diff of input/output ",{"type":13,"tag":131,"props":627,"children":628},{},[629],{"type":19,"value":630},"blinding factors",{"type":19,"value":632},").",{"type":13,"tag":22,"props":634,"children":635},{},[636,638,642,644,648],{"type":19,"value":637},"The transaction type is verified according to (1), whereas the signed kernel balances the transaction according to (2). As we mentioned, by ",{"type":13,"tag":131,"props":639,"children":640},{},[641],{"type":19,"value":272},{"type":19,"value":643}," depends on the ",{"type":13,"tag":197,"props":645,"children":646},{"className":7},[647],{"type":19,"value":201},{"type":19,"value":649}," in an opaque way, hence there's no feasible way to substitute different inputs/outputs in the transaction after it was signed.",{"type":13,"tag":452,"props":651,"children":653},{"id":652},"transaction-signing",[654],{"type":19,"value":655},"Transaction signing",{"type":13,"tag":22,"props":657,"children":658},{},[659],{"type":19,"value":660},"For all the mentioned transaction types the host supplies the following:",{"type":13,"tag":33,"props":662,"children":663},{},[664,675,680],{"type":13,"tag":37,"props":665,"children":666},{},[667,669,673],{"type":19,"value":668},"List of input/output ",{"type":13,"tag":197,"props":670,"children":671},{"className":7},[672],{"type":19,"value":201},{"type":19,"value":674},"s.",{"type":13,"tag":37,"props":676,"children":677},{},[678],{"type":19,"value":679},"Kernel lock height (min/max height)",{"type":13,"tag":37,"props":681,"children":682},{},[683],{"type":19,"value":684},"Kernel fee",{"type":13,"tag":22,"props":686,"children":687},{},[688,690,695],{"type":19,"value":689},"Upon signing, as usual, the excess _blinding factor of the transaction is split into 2 parts in a pseudo-random way: one goes to the kernel commitment, the other goes to the ",{"type":13,"tag":131,"props":691,"children":692},{},[693],{"type":19,"value":694},"offset",{"type":19,"value":696}," (plain scalar). This is done for all the MW transactions for a better obfuscation.",{"type":13,"tag":22,"props":698,"children":699},{},[700],{"type":19,"value":701},"Send and Receive are mutual transactions, that follow the following ritual:",{"type":13,"tag":60,"props":703,"children":704},{},[705,710,715],{"type":13,"tag":37,"props":706,"children":707},{},[708],{"type":19,"value":709},"Sender creates its part of the kernel commitment, and sends it to the receiver",{"type":13,"tag":37,"props":711,"children":712},{},[713],{"type":19,"value":714},"Receiver adds its part of the commitment, signs it, and sends it back to the sender.",{"type":13,"tag":37,"props":716,"children":717},{},[718],{"type":19,"value":719},"Sender finishes its part.",{"type":13,"tag":22,"props":721,"children":722},{},[723],{"type":19,"value":724},"Split transaction (where the user sends funds to itself) is signed in a single invocation.",{"type":13,"tag":14,"props":726,"children":728},{"id":727},"split-transaction",[729],{"type":19,"value":730},"Split transaction",{"type":13,"tag":22,"props":732,"children":733},{},[734,736,740],{"type":19,"value":735},"This is the simplest case, as there's no additional transaction party. The HW wallet analyzes the input/output ",{"type":13,"tag":197,"props":737,"children":738},{"className":7},[739],{"type":19,"value":201},{"type":19,"value":741},"s to make sure no funds \"disappear\". Means the user only spends the transaction fee.",{"type":13,"tag":22,"props":743,"children":744},{},[745,747,751,753,757],{"type":19,"value":746},"If everything matches and the user authorizes it - the HW wallet generates the kernel ",{"type":13,"tag":131,"props":748,"children":749},{},[750],{"type":19,"value":272},{"type":19,"value":752}," in a deterministic way, and then generates the kernel commitment + signature, and the appropriate ",{"type":13,"tag":131,"props":754,"children":755},{},[756],{"type":19,"value":694},{"type":19,"value":306},{"type":13,"tag":14,"props":759,"children":761},{"id":760},"receive-transaction",[762],{"type":19,"value":763},"Receive transaction",{"type":13,"tag":22,"props":765,"children":766},{},[767,769,773],{"type":19,"value":768},"As usual the HW wallet analyzes the input/output ",{"type":13,"tag":197,"props":770,"children":771},{"className":7},[772],{"type":19,"value":201},{"type":19,"value":774},"s to make sure it receives funds.",{"type":13,"tag":22,"props":776,"children":777},{},[778,782,784,788],{"type":13,"tag":123,"props":779,"children":780},{},[781],{"type":19,"value":127},{"type":19,"value":783}," currently it's allowed to receive only one asset type at a time, i.e. exchanging different assets in the same transaction is currently not allowed (as right now we don't have appropriate ",{"type":13,"tag":197,"props":785,"children":786},{"className":7},[787],{"type":19,"value":339},{"type":19,"value":789}," for this).",{"type":13,"tag":22,"props":791,"children":792},{},[793],{"type":19,"value":794},"According to the ritual, by the time of invocation the sender has already produced its part. This includes the following:",{"type":13,"tag":33,"props":796,"children":797},{},[798,803],{"type":13,"tag":37,"props":799,"children":800},{},[801],{"type":19,"value":802},"Kernel commitment",{"type":13,"tag":37,"props":804,"children":805},{},[806],{"type":19,"value":807},"Kernel signature \"public nonce\"",{"type":13,"tag":22,"props":809,"children":810},{},[811,813,817,819,823],{"type":19,"value":812},"If everything matches - the HW wallet generates its part of the kernel ",{"type":13,"tag":131,"props":814,"children":815},{},[816],{"type":19,"value":272},{"type":19,"value":818}," in a deterministic way, and then generates its part of the kernel commitment and signature, and the appropriate ",{"type":13,"tag":131,"props":820,"children":821},{},[822],{"type":19,"value":694},{"type":19,"value":306},{"type":13,"tag":22,"props":825,"children":826},{},[827,829,833],{"type":19,"value":828},"In addition to this, the HW wallet also signs the ",{"type":13,"tag":197,"props":830,"children":831},{"className":7},[832],{"type":19,"value":339},{"type":19,"value":834},". The Kernel ID, value and asset type are deduced automatically. The following additional parameters are specified by the host for the signature:",{"type":13,"tag":33,"props":836,"children":837},{},[838,846],{"type":13,"tag":37,"props":839,"children":840},{},[841,842],{"type":19,"value":364},{"type":13,"tag":197,"props":843,"children":844},{"className":7},[845],{"type":19,"value":324},{"type":13,"tag":37,"props":847,"children":848},{},[849,851,855,857,861,863,867],{"type":19,"value":850},"Self ",{"type":13,"tag":197,"props":852,"children":853},{"className":7},[854],{"type":19,"value":314},{"type":19,"value":856},", which corresponds to the ",{"type":13,"tag":197,"props":858,"children":859},{"className":7},[860],{"type":19,"value":324},{"type":19,"value":862}," expected by the sender. The HW wallet generates the appropriate private key, and signs the ",{"type":13,"tag":197,"props":864,"children":865},{"className":7},[866],{"type":19,"value":339},{"type":19,"value":868}," by it.",{"type":13,"tag":14,"props":870,"children":872},{"id":871},"send-transaction",[873],{"type":19,"value":874},"Send transaction",{"type":13,"tag":22,"props":876,"children":877},{},[878,880,884],{"type":19,"value":879},"This is the most complex case. To sign the send transaction the HW wallet should be invoked twice (as can be seen according to the ritual). It also needs a ",{"type":13,"tag":131,"props":881,"children":882},{},[883],{"type":19,"value":135},{"type":19,"value":885}," that should retain valid for the duration of the transaction.",{"type":13,"tag":22,"props":887,"children":888},{},[889,891,896],{"type":19,"value":890},"When the HW wallet is invoked to sign the send transaction, the host, among other things, specifies the nonce ",{"type":13,"tag":131,"props":892,"children":893},{},[894],{"type":19,"value":895},"slot",{"type":19,"value":897}," which should be used to this transaction (the slot management, i.e. which ongoing transaction uses which slot - up to the host).",{"type":13,"tag":22,"props":899,"children":900},{},[901],{"type":19,"value":902},"On the first invocation the HW wallet generates the kernel parameters (commitment and public nonce) based on the visible parameters and this nonce.",{"type":13,"tag":22,"props":904,"children":905},{},[906,908,912],{"type":19,"value":907},"On the second invocation it verifies receiver part, verifies the ",{"type":13,"tag":197,"props":909,"children":910},{"className":7},[911],{"type":19,"value":339},{"type":19,"value":913}," signed by the receiver, and asks for user permission to transfer the funds to this receiver. If everything is ok - the kernel is signed.",{"type":13,"tag":22,"props":915,"children":916},{},[917,921,923,927,929,933],{"type":13,"tag":123,"props":918,"children":919},{},[920],{"type":19,"value":127},{"type":19,"value":922}," just before signing, the HW wallet re-generates the value of the ",{"type":13,"tag":131,"props":924,"children":925},{},[926],{"type":19,"value":895},{"type":19,"value":928}," used in this transaction (re-generates its value in a deterministic way). This is to prevent malicious host make HW wallet sign different transactions using the same ",{"type":13,"tag":131,"props":930,"children":931},{},[932],{"type":19,"value":135},{"type":19,"value":306},{"type":13,"tag":53,"props":935,"children":937},{"id":936},"note-regarding-rangeproof-generation",[938],{"type":19,"value":939},"Note regarding rangeproof generation",{"type":13,"tag":22,"props":941,"children":942},{},[943,945,949],{"type":19,"value":944},"Beam uses bulletproof as a rangeproof, which is computationally heavy for a device with limited capabilities. To improve the performance the host and HW wallet perform a multi-party computation. The HW wallet participates only where the ",{"type":13,"tag":131,"props":946,"children":947},{},[948],{"type":19,"value":272},{"type":19,"value":950}," is necessary.",{"type":13,"tag":22,"props":952,"children":953},{},[954,956,960],{"type":19,"value":955},"However, apart from being valid, the generated bulletproof must also be detectable by the user ",{"type":13,"tag":197,"props":957,"children":958},{"className":7},[959],{"type":19,"value":282},{"type":19,"value":961},". This is obviously unacceptable if a malicious host can generate an output which would be \"invisible\" to the user after the transaction.",{"type":13,"tag":22,"props":963,"children":964},{},[965],{"type":19,"value":966},"Because of this there's a considerable amount of computation that HW wallet needs to do. In particular it needs to calculate a multi-exponentiation of 129 generators. Yet it's only a fairly small fraction of the overall computation.",{"type":13,"tag":53,"props":968,"children":970},{"id":969},"note-regarding-paymentproof-and-bbs-addresses",[971,973,977],{"type":19,"value":972},"Note regarding ",{"type":13,"tag":197,"props":974,"children":975},{"className":7},[976],{"type":19,"value":339},{"type":19,"value":978}," and BBS addresses",{"type":13,"tag":22,"props":980,"children":981},{},[982,984,988,990,994],{"type":19,"value":983},"Normally wallets negotiate over BBS system, each has a BBS address key, by which it tries to decrypt all the BBS traffic and chase the messages intended to it. Then during the transaction the BBS public address is also treated as the peer ",{"type":13,"tag":197,"props":985,"children":986},{"className":7},[987],{"type":19,"value":324},{"type":19,"value":989},", i.e. the sender expects the receiver to sign the ",{"type":13,"tag":197,"props":991,"children":992},{"className":7},[993],{"type":19,"value":339},{"type":19,"value":868},{"type":13,"tag":22,"props":996,"children":997},{},[998,1000,1004,1006,1011,1013,1017],{"type":19,"value":999},"However for the HW wallet it's not feasible to decode all the BBS traffic. Hence we decided to separate the BBS and the ",{"type":13,"tag":197,"props":1001,"children":1002},{"className":7},[1003],{"type":19,"value":324},{"type":19,"value":1005},". Now in order to send/receive funds the users exchange ",{"type":13,"tag":131,"props":1007,"children":1008},{},[1009],{"type":19,"value":1010},"Tokens",{"type":19,"value":1012}," (over secure channel), which optionally include both the BBS address and the ",{"type":13,"tag":197,"props":1014,"children":1015},{"className":7},[1016],{"type":19,"value":324},{"type":19,"value":306},{"type":13,"tag":22,"props":1019,"children":1020},{},[1021,1023,1027,1029,1034],{"type":19,"value":1022},"Conceptually the BBS address belongs to the entity you are directly talking to, whereas the ",{"type":13,"tag":197,"props":1024,"children":1025},{"className":7},[1026],{"type":19,"value":324},{"type":19,"value":1028}," belongs to the ",{"type":13,"tag":567,"props":1030,"children":1031},{},[1032],{"type":19,"value":1033},"final",{"type":19,"value":1035}," sender/recipient of the funds. In other words, the software wallet is a proxy, which may be compromised, whereas still there is a confirmation that the final recipient gets all the funds.",{"title":7,"searchDepth":1037,"depth":1037,"links":1038},2,[1039,1041,1042,1043,1048,1049],{"id":16,"depth":1040,"text":20},3,{"id":55,"depth":1037,"text":58},{"id":186,"depth":1037,"text":189},{"id":592,"depth":1037,"text":595,"children":1044},[1045,1046,1047],{"id":727,"depth":1040,"text":730},{"id":760,"depth":1040,"text":763},{"id":871,"depth":1040,"text":874},{"id":936,"depth":1037,"text":939},{"id":969,"depth":1037,"text":1050},"Note regarding PaymentProof and BBS addresses","markdown","content:docs:core-tech:HW-wallet-design.md","content","docs/core-tech/HW-wallet-design.md","md",1702260897749]