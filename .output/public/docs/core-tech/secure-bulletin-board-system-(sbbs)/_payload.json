[{"data":1,"prerenderedAt":677},["Reactive",2],{"content-query-n0QvZFpMNs":3},{"_path":4,"_dir":5,"_draft":6,"_partial":6,"_locale":7,"title":8,"description":7,"body":9,"_type":672,"_id":673,"_source":674,"_file":675,"_extension":676},"/docs/core-tech/secure-bulletin-board-system-(sbbs)","core-tech",false,"","Secure bulletin board system (SBBS)",{"type":10,"children":11,"toc":666},"root",[12,20,27,33,39,44,51,64,99,153,158,163,195,234,270,275,280,325,330,340,357,363,368,374,379,417,423,428,451,524,530,549,565,589,600,629,639],{"type":13,"tag":14,"props":15,"children":17},"element","h1",{"id":16},"secure-bulletin-board-system-sbbs",[18],{"type":19,"value":8},"text",{"type":13,"tag":21,"props":22,"children":24},"h2",{"id":23},"overview",[25],{"type":19,"value":26},"Overview",{"type":13,"tag":28,"props":29,"children":30},"p",{},[31],{"type":19,"value":32},"The main goal of BBS is to allow wallets to communicate with each other in a secure and asynchronous manner. Using BBS wallets allows individuals to exchange messages, even if one of the individuals is offline. In general, BBS is a virtual board, where users can place messages, and each message is encrypted. For encryption, the public key of the recipient is used. This implies that the recipient’s public key is his address in terms of this system. Every participant who is interested in messages from this board, observes and tries to decrypt new messages with his private key, and he manages to do so only if the message has been addressed to him. It consists of server and client sides. The server is implemented as a part of the node. The client is a wallet.",{"type":13,"tag":21,"props":34,"children":36},{"id":35},"server-side",[37],{"type":19,"value":38},"Server side",{"type":13,"tag":28,"props":40,"children":41},{},[42],{"type":19,"value":43},"BBS is a part of our node, This implementation implies that messages are sent to n=32 channels, which can ultimately change. The channel is calculated from the public key (first 5 bits). A client has to subscribe to a specific channel, and the server will retranslate all of the new messages to subscribers. Also, the server receives and stores within the database all new messages and exchanges these messages with other servers using a P2P protocol. This logic is implemented in class Node::Peer. It represents the node’s peer and handles the node’s P2P message. BBS messages are a part of node P2P protocol.",{"type":13,"tag":45,"props":46,"children":48},"h4",{"id":47},"bbssubscribe",[49],{"type":19,"value":50},"BbsSubscribe",{"type":13,"tag":28,"props":52,"children":53},{},[54,56,62],{"type":19,"value":55},"Message ",{"type":13,"tag":57,"props":58,"children":59},"code",{"className":7},[60],{"type":19,"value":61},"tp",{"type":19,"value":63}," allows clients to subscribe/unsubscribe to notifications from the node about new messages.",{"type":13,"tag":65,"props":66,"children":67},"ul",{},[68,79,89],{"type":13,"tag":69,"props":70,"children":71},"li",{},[72,77],{"type":13,"tag":57,"props":73,"children":74},{"className":7},[75],{"type":19,"value":76},"BbsChannel m_Channel",{"type":19,"value":78}," – channel to listen.",{"type":13,"tag":69,"props":80,"children":81},{},[82,87],{"type":13,"tag":57,"props":83,"children":84},{"className":7},[85],{"type":19,"value":86},"Timestamp m_TimeFrom",{"type":19,"value":88}," – timestamp used to avoid sending of out-of-date messages.",{"type":13,"tag":69,"props":90,"children":91},{},[92,97],{"type":13,"tag":57,"props":93,"children":94},{"className":7},[95],{"type":19,"value":96},"bool m_On",{"type":19,"value":98}," – subscribe/unsubscribe flag.",{"type":13,"tag":28,"props":100,"children":101},{},[102,104,109,111,116,118,123,125,130,132,137,139,144,146,151],{"type":19,"value":103},"When the server receives this message from the peer with ",{"type":13,"tag":57,"props":105,"children":106},{"className":7},[107],{"type":19,"value":108},"m_On == true",{"type":19,"value":110}," and ",{"type":13,"tag":57,"props":112,"children":113},{"className":7},[114],{"type":19,"value":115},"Node::Peer::m_Subscriptions",{"type":19,"value":117}," list doesn’t have it (the look up is made by channel), then the node adds a new instance of ",{"type":13,"tag":57,"props":119,"children":120},{"className":7},[121],{"type":19,"value":122},"Node::Bbs::Subscription",{"type":19,"value":124}," to this list and to ",{"type":13,"tag":57,"props":126,"children":127},{"className":7},[128],{"type":19,"value":129},"Node::m_Bbs::m_Subscribed",{"type":19,"value":131},". If the node has messages for this channel that are sent after given timestamp, then it sends them as a new ",{"type":13,"tag":57,"props":133,"children":134},{"className":7},[135],{"type":19,"value":136},"BbsMsg",{"type":19,"value":138}," to this subscriber. If ",{"type":13,"tag":57,"props":140,"children":141},{"className":7},[142],{"type":19,"value":143},"m_On == false",{"type":19,"value":145}," and a given subscriber exists in ",{"type":13,"tag":57,"props":147,"children":148},{"className":7},[149],{"type":19,"value":150},"m_Subscriptions",{"type":19,"value":152}," list, the node simply removes it.",{"type":13,"tag":45,"props":154,"children":156},{"id":155},"bbsmsg",[157],{"type":19,"value":136},{"type":13,"tag":28,"props":159,"children":160},{},[161],{"type":19,"value":162},"A message which is used to put an encrypted message onto the board or to exchange between nodes:",{"type":13,"tag":65,"props":164,"children":165},{},[166,175,185],{"type":13,"tag":69,"props":167,"children":168},{},[169,173],{"type":13,"tag":57,"props":170,"children":171},{"className":7},[172],{"type":19,"value":76},{"type":19,"value":174}," – target channel.",{"type":13,"tag":69,"props":176,"children":177},{},[178,183],{"type":13,"tag":57,"props":179,"children":180},{"className":7},[181],{"type":19,"value":182},"Timestamp m_TimePosted",{"type":19,"value":184}," – timestamp, when wallet has posted message to bbs.",{"type":13,"tag":69,"props":186,"children":187},{},[188,193],{"type":13,"tag":57,"props":189,"children":190},{"className":7},[191],{"type":19,"value":192},"ByteBuffer m_Message",{"type":19,"value":194}," – the encrypted content.",{"type":13,"tag":28,"props":196,"children":197},{},[198,200,205,207,211,213,218,220,225,227,232],{"type":19,"value":199},"When this message is received, server gets current timestamp. If ",{"type":13,"tag":57,"props":201,"children":202},{"className":7},[203],{"type":19,"value":204},"m_TimePosted",{"type":19,"value":206}," \u003C= currentTime-24 hours, i.e. to old, or ",{"type":13,"tag":57,"props":208,"children":209},{"className":7},[210],{"type":19,"value":204},{"type":19,"value":212}," > currentTime + 2 hour (someone generates messages from future), then node rejects this message. If it doesn’t have this message it stores it in database, sends ",{"type":13,"tag":57,"props":214,"children":215},{"className":7},[216],{"type":19,"value":217},"BbsHaveMsg",{"type":19,"value":219},", to inform other peers about new bbs message, and sends ",{"type":13,"tag":57,"props":221,"children":222},{"className":7},[223],{"type":19,"value":224},"BbsMsg ",{"type":19,"value":226},"to subscriberd interested in messages from ",{"type":13,"tag":57,"props":228,"children":229},{"className":7},[230],{"type":19,"value":231},"m_Channel",{"type":19,"value":233},".",{"type":13,"tag":28,"props":235,"children":236},{},[237,239,244,246,251,253,257,259,263,265,269],{"type":19,"value":238},"When this message is received, the server gets a current timestamp. If ",{"type":13,"tag":57,"props":240,"children":241},{"className":7},[242],{"type":19,"value":243},"m_TimePosted \u003C= currentTime-24",{"type":19,"value":245}," hours, i.e. too old, or ",{"type":13,"tag":57,"props":247,"children":248},{"className":7},[249],{"type":19,"value":250},"m_TimePosted > currentTime + 2",{"type":19,"value":252}," hours (someone generates messages from the future), then the node rejects this message. If it doesn’t have this message, it is stored in the database, and sent ",{"type":13,"tag":57,"props":254,"children":255},{"className":7},[256],{"type":19,"value":217},{"type":19,"value":258},", in order to inform other peers about new bbs message. It sends ",{"type":13,"tag":57,"props":260,"children":261},{"className":7},[262],{"type":19,"value":136},{"type":19,"value":264}," to subscribed interested in messages from ",{"type":13,"tag":57,"props":266,"children":267},{"className":7},[268],{"type":19,"value":231},{"type":19,"value":233},{"type":13,"tag":45,"props":271,"children":273},{"id":272},"bbshavemsg",[274],{"type":19,"value":217},{"type":13,"tag":28,"props":276,"children":277},{},[278],{"type":19,"value":279},"A Message which is used by BBS server (node) to exchange information about message that it has.",{"type":13,"tag":65,"props":281,"children":282},{},[283],{"type":13,"tag":69,"props":284,"children":285},{},[286,291,293,298,300,304,306,310,312,317,319,324],{"type":13,"tag":57,"props":287,"children":288},{"className":7},[289],{"type":19,"value":290},"BbsMsgID m_Key",{"type":19,"value":292}," – the message’s key. It is defined as a hash of the ",{"type":13,"tag":57,"props":294,"children":295},{"className":7},[296],{"type":19,"value":297},"m_Message",{"type":19,"value":299}," and the ",{"type":13,"tag":57,"props":301,"children":302},{"className":7},[303],{"type":19,"value":231},{"type":19,"value":305}," in ",{"type":13,"tag":57,"props":307,"children":308},{"className":7},[309],{"type":19,"value":136},{"type":19,"value":311},". In order to handle this message, the node checks if it already has this message. If it doesn’t, it stores it into waitlist ",{"type":13,"tag":57,"props":313,"children":314},{"className":7},[315],{"type":19,"value":316},"Node::m_Bbs::m_W",{"type":19,"value":318}," and sends ",{"type":13,"tag":57,"props":320,"children":321},{"className":7},[322],{"type":19,"value":323},"BbsGetMsg",{"type":19,"value":233},{"type":13,"tag":45,"props":326,"children":328},{"id":327},"bbsgetmsg",[329],{"type":19,"value":323},{"type":13,"tag":28,"props":331,"children":332},{},[333,335,339],{"type":19,"value":334},"A peer server request for bbs message, which occurs as a response to ",{"type":13,"tag":57,"props":336,"children":337},{"className":7},[338],{"type":19,"value":217},{"type":19,"value":233},{"type":13,"tag":65,"props":341,"children":342},{},[343],{"type":13,"tag":69,"props":344,"children":345},{},[346,350,352,356],{"type":13,"tag":57,"props":347,"children":348},{"className":7},[349],{"type":19,"value":290},{"type":19,"value":351}," If the node has a bbs message with a given key, it sends it back as ",{"type":13,"tag":57,"props":353,"children":354},{"className":7},[355],{"type":19,"value":136},{"type":19,"value":233},{"type":13,"tag":45,"props":358,"children":360},{"id":359},"bbspickchannel",[361],{"type":19,"value":362},"BbsPickChannel",{"type":13,"tag":28,"props":364,"children":365},{},[366],{"type":19,"value":367},"The Client asks the server for recommended channels.",{"type":13,"tag":45,"props":369,"children":371},{"id":370},"bbspickchannelres",[372],{"type":19,"value":373},"BbsPickChannelRes",{"type":13,"tag":28,"props":375,"children":376},{},[377],{"type":19,"value":378},"Server channel recommendation",{"type":13,"tag":65,"props":380,"children":381},{},[382],{"type":13,"tag":69,"props":383,"children":384},{},[385,389,391,396,398,403,405,410,412,416],{"type":13,"tag":57,"props":386,"children":387},{"className":7},[388],{"type":19,"value":76},{"type":19,"value":390}," - recommended channel. Once in an hour ",{"type":13,"tag":57,"props":392,"children":393},{"className":7},[394],{"type":19,"value":395},"(Node::m_Cfg::m_Timeout::m_BbsCleanupPeriod_ms)",{"type":19,"value":397}," the node tries to find a channel which is populated with less than 100 listeners ",{"type":13,"tag":57,"props":399,"children":400},{"className":7},[401],{"type":19,"value":402},"(Node::m_Cfg::m_BbsIdealChannelPopulation)",{"type":19,"value":404},". Found value is stored into ",{"type":13,"tag":57,"props":406,"children":407},{"className":7},[408],{"type":19,"value":409},"m_RecommendedChannel",{"type":19,"value":411}," and it is used as a response to ",{"type":13,"tag":57,"props":413,"children":414},{"className":7},[415],{"type":19,"value":362},{"type":19,"value":233},{"type":13,"tag":21,"props":418,"children":420},{"id":419},"client-side",[421],{"type":19,"value":422},"Client side",{"type":13,"tag":28,"props":424,"children":425},{},[426],{"type":19,"value":427},"In the wallet, the BBS communication is placed in WalletNetworkViaBbs class. It allows to send a message to BBS and it manages BBS keys and timestamps. This class contains references to:",{"type":13,"tag":65,"props":429,"children":430},{},[431,441],{"type":13,"tag":69,"props":432,"children":433},{},[434,439],{"type":13,"tag":57,"props":435,"children":436},{"className":7},[437],{"type":19,"value":438},"IWallet& m_Wallet",{"type":19,"value":440}," - which is used for callbacks to wallet object.",{"type":13,"tag":69,"props":442,"children":443},{},[444,449],{"type":13,"tag":57,"props":445,"children":446},{"className":7},[447],{"type":19,"value":448},"proto::FlyClient::INetwork& m_NodeNetwork",{"type":19,"value":450}," - which is used to communicate with the node.",{"type":13,"tag":28,"props":452,"children":453},{},[454,456,461,463,468,470,475,477,482,484,489,491,495,497,502,504,509,511,516,518,522],{"type":19,"value":455},"When the wallet wants to create a new address (from cli, ui) or load already-created addresses from the database, ",{"type":13,"tag":57,"props":457,"children":458},{"className":7},[459],{"type":19,"value":460},"AddOwnAddress()",{"type":19,"value":462}," is called. This method calls ",{"type":13,"tag":57,"props":464,"children":465},{"className":7},[466],{"type":19,"value":467},"IWalletDB::calcKey()",{"type":19,"value":469}," with the key type ",{"type":13,"tag":57,"props":471,"children":472},{"className":7},[473],{"type":19,"value":474},"Bbs",{"type":19,"value":476}," to generate a private key for BBS. The public key is created using ",{"type":13,"tag":57,"props":478,"children":479},{"className":7},[480],{"type":19,"value":481},"proto::Sk2Pk()",{"type":19,"value":483},". Index, which is used for generating a private key that is stored in ",{"type":13,"tag":57,"props":485,"children":486},{"className":7},[487],{"type":19,"value":488},"wallet.db",{"type":19,"value":490},". The wallet will then choose a channel. If the client has not subscribed to the chosen channel, the ",{"type":13,"tag":57,"props":492,"children":493},{"className":7},[494],{"type":19,"value":50},{"type":19,"value":496}," message is posted to the node via ",{"type":13,"tag":57,"props":498,"children":499},{"className":7},[500],{"type":19,"value":501},"m_NodeNetwork",{"type":19,"value":503},". If the wallet wants to send a message via Bbs it calls the overridden method ",{"type":13,"tag":57,"props":505,"children":506},{"className":7},[507],{"type":19,"value":508},"Send()",{"type":19,"value":510},". In this method, the given message is encrypted using ",{"type":13,"tag":57,"props":512,"children":513},{"className":7},[514],{"type":19,"value":515},"proto::BbsEncrypt()",{"type":19,"value":517}," and sent to ",{"type":13,"tag":57,"props":519,"children":520},{"className":7},[521],{"type":19,"value":501},{"type":19,"value":523},". If the wallet received the bbs message it updates the timestamp for the channel and stores them to the database.",{"type":13,"tag":45,"props":525,"children":527},{"id":526},"usage-of-bbs-to-exchange-message",[528],{"type":19,"value":529},"Usage of BBS to exchange message",{"type":13,"tag":28,"props":531,"children":532},{},[533,535,541,543,548],{"type":19,"value":534},"There are two sides wallet ",{"type":13,"tag":536,"props":537,"children":538},"strong",{},[539],{"type":19,"value":540},"A",{"type":19,"value":542}," and wallet ",{"type":13,"tag":536,"props":544,"children":545},{},[546],{"type":19,"value":547},"B",{"type":19,"value":233},{"type":13,"tag":550,"props":551,"children":553},"h5",{"id":552},"a-and-b",[554,558,559,563],{"type":13,"tag":536,"props":555,"children":556},{},[557],{"type":19,"value":540},{"type":19,"value":110},{"type":13,"tag":536,"props":560,"children":561},{},[562],{"type":19,"value":547},{"type":19,"value":564},":",{"type":13,"tag":65,"props":566,"children":567},{},[568,573,578],{"type":13,"tag":69,"props":569,"children":570},{},[571],{"type":19,"value":572},"picks or generates a pair of keys public and private",{"type":13,"tag":69,"props":574,"children":575},{},[576],{"type":19,"value":577},"choose channel//asks BBS server (node) for suitable",{"type":13,"tag":69,"props":579,"children":580},{},[581,583,587],{"type":19,"value":582},"sends ",{"type":13,"tag":57,"props":584,"children":585},{"className":7},[586],{"type":19,"value":50},{"type":19,"value":588}," to chosen channel, if needed",{"type":13,"tag":550,"props":590,"children":592},{"id":591},"wallet-a",[593,595,599],{"type":19,"value":594},"Wallet ",{"type":13,"tag":536,"props":596,"children":597},{},[598],{"type":19,"value":540},{"type":19,"value":564},{"type":13,"tag":65,"props":601,"children":602},{},[603,608,613,618],{"type":13,"tag":69,"props":604,"children":605},{},[606],{"type":19,"value":607},"chooses the address of target recipient (his public key)",{"type":13,"tag":69,"props":609,"children":610},{},[611],{"type":19,"value":612},"creates a message, it has to contain its public key as an address for answer",{"type":13,"tag":69,"props":614,"children":615},{},[616],{"type":19,"value":617},"encrypts this message using pub",{"type":13,"tag":69,"props":619,"children":620},{},[621,623,627],{"type":19,"value":622},"creates ",{"type":13,"tag":57,"props":624,"children":625},{"className":7},[626],{"type":19,"value":136},{"type":19,"value":628},", fills it and sends to BBS server",{"type":13,"tag":550,"props":630,"children":632},{"id":631},"wallet-b",[633,634,638],{"type":19,"value":594},{"type":13,"tag":536,"props":635,"children":636},{},[637],{"type":19,"value":547},{"type":19,"value":564},{"type":13,"tag":65,"props":640,"children":641},{},[642,651,656,661],{"type":13,"tag":69,"props":643,"children":644},{},[645,647],{"type":19,"value":646},"receives ",{"type":13,"tag":57,"props":648,"children":649},{"className":7},[650],{"type":19,"value":136},{"type":13,"tag":69,"props":652,"children":653},{},[654],{"type":19,"value":655},"updates timestamps for the message channel",{"type":13,"tag":69,"props":657,"children":658},{},[659],{"type":19,"value":660},"tries to decrypt bbs message using the known key for message channel",{"type":13,"tag":69,"props":662,"children":663},{},[664],{"type":19,"value":665},"if succeeded, it notifies wallet",{"title":7,"searchDepth":667,"depth":667,"links":668},2,[669,670,671],{"id":23,"depth":667,"text":26},{"id":35,"depth":667,"text":38},{"id":419,"depth":667,"text":422},"markdown","content:docs:core-tech:Secure-bulletin-board-system-(SBBS).md","content","docs/core-tech/Secure-bulletin-board-system-(SBBS).md","md",1702260906865]