[{"_path":"/docs/core-tech/transaction-creation-protocol","_dir":"core-tech","_draft":false,"_partial":false,"_locale":"","title":"Transaction creation protocol","description":"Creating transactions in Beam (as with other MimbleWimble implementations) is interactive. In order to create a new Beam transaction, the sending and receiving wallets communicate with each other. The wallets exchange parameters which produce the transaction. As a result, the protocol between the wallets is extendable.","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"transaction-creation-protocol"},"children":[{"type":"text","value":"Transaction creation protocol"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Creating transactions in Beam (as with other MimbleWimble implementations) is interactive. In order to create a new Beam transaction, the sending and receiving wallets communicate with each other. The wallets exchange parameters which produce the transaction. As a result, the protocol between the wallets is extendable."}]},{"type":"element","tag":"h2","props":{"id":"what-is-a-transaction-in-beam"},"children":[{"type":"text","value":"What is a transaction in Beam?"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Any Beam transaction contains the following parameters:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A Set of input UTXOs (Inputs), which have to already be present in the blockchain."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"A Set of newly created UTXOs (Outputs) and rangeproofs for each output"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The Explicit excess (offset)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The transaction kernel"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The transaction kernel requires the following parameters:"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Blinded excess"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Transaction fee"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Minimum height"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Maximum height"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Signature. This is a Schnorr’s multi-signature which signs all the values listed above"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The minimum and maximum height values set the time in which the transaction is valid. Nodes will reject a transaction if its height is below the minimum height and greater than the maximum height"}]},{"type":"element","tag":"h3","props":{"id":"a-simple-transaction-flow"},"children":[{"type":"text","value":"A simple transaction flow."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"In the following example, a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Sender"}]},{"type":"text","value":" makes a payment to a "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Receiver"}]},{"type":"text","value":"."}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Sender"}]},{"type":"text","value":" and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Receiver"}]},{"type":"text","value":" agree on the "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"amount"}]},{"type":"text","value":" and "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"fee"}]},{"type":"text","value":"."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Sender"}]},{"type":"text","value":" selects input UTXO which allow paying "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"amount + fee"}]},{"type":"text","value":".\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"If the sum of inputs is greater than "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"amount + fee"}]},{"type":"text","value":", "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Sender"}]},{"type":"text","value":" also creates output UTXO for the change."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Sender"}]},{"type":"text","value":" creates overall blinding excess value "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"blindingExcess_S"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"offset_S"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"The "},{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Receiver"}]},{"type":"text","value":" creates outputs for a given amount and calculates blinding excess "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"blindingExcess_R"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"offset_R"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Both parties generate nonces "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"nonce_S"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"nonce_R"}]},{"type":"text","value":" respectively."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Both parties send each other public forms of excesses:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicNonce_S = nonce_S*G"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicNonce_R = nonce_R*G"}]},{"type":"text","value":" – public nonces"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicExcess_S = blindingExcess_S*G"}]},{"type":"text","value":" and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicExcess_R = blindingExcess_R*G"}]},{"type":"text","value":" – public blinding excessed"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Both parties compute total blinding excess and total public nonce:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"total blinding excess: "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"X = publicExcess_S + publicExcess_R"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"total public nonce: "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"K = publicNonce_S + publicNonce_R"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Both parties compute a Schnorr’s signature challenge:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"e = H(K|M)"}]},{"type":"text","value":", where "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"M"}]},{"type":"text","value":" is a signed message, it calculates from kernel and it includes "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"X"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"fee"}]},{"type":"text","value":", "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"min height"}]},{"type":"text","value":", and "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"max height"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Both parties compute and send  to each other partial signatures:\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"S"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"partialSignature_S = publicNonce_S + e*publicExcess_S"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"R"}]},{"type":"text","value":": "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"partialSignature_R = publicNonce_R + e*publicExcess_R"}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Final signature is computed: "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"signature = partialSignature_S + partialSignature_R"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"[[/images/SimpleTransactionFlow.png]]"}]},{"type":"element","tag":"h2","props":{"id":"wallet-to-wallet-protocol"},"children":[{"type":"text","value":"Wallet-To-Wallet protocol"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"The protocol itself consists of a single message and can be implemented in all the possible scenarios and transaction types. This message can be encapsulated and passed to other parties by different protocols, such as a direct message over a peer-to-peer connection, or an indirect message sent through the Secure Bulletin Board System (SBBS), and others."}]},{"type":"element","tag":"h2","props":{"id":"settxparameter"},"children":[{"type":"text","value":"SetTxParameter"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Transfers a bundle of transaction parameters from one wallet to another. This message may initiate a new transaction."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"WalletID m_From"}]},{"type":"text","value":" – The response address set by the wallet, used when sending messages over SBBS. "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"WalletID"}]},{"type":"text","value":" is a packed 8 bytes of the SBBS channel and 32 bytes of the wallet’s public key."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"TxID m_TxID"}]},{"type":"text","value":" – Unique 16-byte transaction identifier. Generated by the transaction initiator."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"TxType m_Type"}]},{"type":"text","value":" – Transaction type (Simple, AtomicSwap etc.) This field is used to create a new transaction object when this message is the first in the line, or for verification purposes otherwise."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"std::vector<std::pair<TxParameterID, ByteBuffer>> m_Parameters"}]},{"type":"text","value":" – Vector of transaction parameter pairs. Each parameter is a pair of IDs from the range "},{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"0...255"}]},{"type":"text","value":" and the value represented as a raw bytes buffer. ID values are separated in two parts: private and public (IDs below "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"PrivateFirstParam == 128"}]},{"type":"text","value":" are private). Public parameters come from outside and they are not allowed to be overridden. Private parameters do not have limitations."}]}]},{"type":"element","tag":"h2","props":{"id":"example-simple-transaction"},"children":[{"type":"text","value":"Example: Simple transaction"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"A simple transaction is a payment from Wallet A to Wallet B, with a change UTXO and a fee."}]},{"type":"element","tag":"h3","props":{"id":"wallet-a-sends-an-invitation"},"children":[{"type":"text","value":"Wallet A sends an invitation."}]},{"type":"element","tag":"pre","props":{"className":["language-javascript"],"code":"SetTxParameter\n{\n    m_From: XXXXXX // response address set by wallet A. \n    m_TxID: 651798 //newly generated random identifier.\n    m_Type: TxType::Simple,\n    [\n        {TxParameterID::Amount, amount},\n        {TxParameterID::Fee, fee},\n        {TxParameterID::MinHeight, minHeight}, \n        {TxParameterID::MaxHeight, maxHeight}, \n        {TxParameterID::IsSender, false}, // flag to distinguish the sender from the receiver \n        {TxParameterID::PeerProtoVersion, protocolVersion}, // current version is 1\n        {TxParameterID::PeerPublicExcess, publicExcess}, \n        {TxParameterID::PeerPublicNonce, publicNonce}\n    ]\n}\n","language":"javascript","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"SetTxParameter\n{\n    m_From: XXXXXX // response address set by wallet A. \n    m_TxID: 651798 //newly generated random identifier.\n    m_Type: TxType::Simple,\n    [\n        {TxParameterID::Amount, amount},\n        {TxParameterID::Fee, fee},\n        {TxParameterID::MinHeight, minHeight}, \n        {TxParameterID::MaxHeight, maxHeight}, \n        {TxParameterID::IsSender, false}, // flag to distinguish the sender from the receiver \n        {TxParameterID::PeerProtoVersion, protocolVersion}, // current version is 1\n        {TxParameterID::PeerPublicExcess, publicExcess}, \n        {TxParameterID::PeerPublicNonce, publicNonce}\n    ]\n}\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"minHeight"}]},{"type":"text","value":" - if the height of the blockchain is less than the specified value, the transaction will not be taken into account"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"maxHeight"}]},{"type":"text","value":" - if the height of the blockchain is greater than the specified then the node will reject the created transaction."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"protocolVersion"}]},{"type":"text","value":" - version of wallet-to-wallet protocol"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicExcess"}]},{"type":"text","value":" - the public form of the sender’s excess calculated from blinding factors of inputs and change output."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicNonce"}]},{"type":"text","value":" - sender generates a secret nonce, this is its public value."}]}]},{"type":"element","tag":"h3","props":{"id":"wallet-b-confirms-invitation"},"children":[{"type":"text","value":"Wallet B confirms invitation."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Wallet B creates an output for the received amount and generates a nonce to sign the transaction."}]},{"type":"element","tag":"pre","props":{"className":["language-javascript"],"code":"SetTxParameter\n{\n    m_From: YYYYYY  // response address set by wallet B.  \n    m_TxID: 651798, // the ID set by the  sender.\n    m_Type: TxType::Simple,\n    [\n        {TxParameterID::PeerProtoVersion, protocolVersion}\n        {TxParameterID::PeerPublicExcess, peerPublicExcess},\n        {TxParameterID::PeerSignature, receiversPartialSignature},\n        {TxParameterID::PeerPublicNonce, publicNonce},\n        {TxParameterID::PeerOutputs, outputs},\n        {TxParameterID::PeerOffset, offset}\n    ]\n}\n","language":"javascript","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"SetTxParameter\n{\n    m_From: YYYYYY  // response address set by wallet B.  \n    m_TxID: 651798, // the ID set by the  sender.\n    m_Type: TxType::Simple,\n    [\n        {TxParameterID::PeerProtoVersion, protocolVersion}\n        {TxParameterID::PeerPublicExcess, peerPublicExcess},\n        {TxParameterID::PeerSignature, receiversPartialSignature},\n        {TxParameterID::PeerPublicNonce, publicNonce},\n        {TxParameterID::PeerOutputs, outputs},\n        {TxParameterID::PeerOffset, offset}\n    ]\n}\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"protocolVersion"}]},{"type":"text","value":" - version of wallet-to-wallet protocol"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"peerPublicExcess"}]},{"type":"text","value":" - receiver’s public excess, calculated from the output’s blinding factors."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"receiversPartialSignature"}]},{"type":"text","value":" - receiver’s part of Schnorr multi-signature."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"publicNonce"}]},{"type":"text","value":" - the public form of a nonce for signature."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"outputs"}]},{"type":"text","value":" - vector of outputs, created by the receiver."}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"offset"}]},{"type":"text","value":" - offset value, randomly taken part of outputs blinding factor."}]}]},{"type":"element","tag":"h3","props":{"id":"wallet-a-confirms-the-transaction"},"children":[{"type":"text","value":"Wallet A confirms the transaction."}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If the receiver’s signature is valid, sender calculates its part of the signature.\nNow Wallet A has all required data to create the transaction and broadcast it to a node."}]},{"type":"element","tag":"h3","props":{"id":"cancellation-or-error"},"children":[{"type":"text","value":"Cancellation or error"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"If any of the participants wish to interrupt the process, they broadcast the following message:"}]},{"type":"element","tag":"pre","props":{"className":["language-javascript"],"code":"SetTxParameter \n{\n    m_From: ZZZZZZ // response address set by the wallet\n    m_TxID: 651798, // the ID set by the sender.    m_Type: TxType::Simple,\n    [\n        {TxParameterID::FailureReason, reason}\n    ]\n}\n","language":"javascript","meta":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"SetTxParameter \n{\n    m_From: ZZZZZZ // response address set by the wallet\n    m_TxID: 651798, // the ID set by the sender.    m_Type: TxType::Simple,\n    [\n        {TxParameterID::FailureReason, reason}\n    ]\n}\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"reason"}]},{"type":"text","value":" - 32 bit code of failure reason"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Note: Cancellation is possible only in specific moments of this flow. Receiver can cancel transaction only during invitation, i.e. after receiver has accepted invitation and sent his data to the sender, he has no guaranties that transactions will not be written into the blockchain. Sender can interrupt transaction only before he sent transaction to the node."}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"what-is-a-transaction-in-beam","depth":2,"text":"What is a transaction in Beam?","children":[{"id":"a-simple-transaction-flow","depth":3,"text":"A simple transaction flow."}]},{"id":"wallet-to-wallet-protocol","depth":2,"text":"Wallet-To-Wallet protocol"},{"id":"settxparameter","depth":2,"text":"SetTxParameter"},{"id":"example-simple-transaction","depth":2,"text":"Example: Simple transaction","children":[{"id":"wallet-a-sends-an-invitation","depth":3,"text":"Wallet A sends an invitation."},{"id":"wallet-b-confirms-invitation","depth":3,"text":"Wallet B confirms invitation."},{"id":"wallet-a-confirms-the-transaction","depth":3,"text":"Wallet A confirms the transaction."},{"id":"cancellation-or-error","depth":3,"text":"Cancellation or error"}]}]}},"_type":"markdown","_id":"content:docs:core-tech:Transaction-creation-protocol.md","_source":"content","_file":"docs/core-tech/Transaction-creation-protocol.md","_extension":"md"}]